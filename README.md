# 🧠 NLBAging - ComfyUI Installation & Setup Guide

Welcome to the **NLBAging** project, an image processing workflow built on top of **ComfyUI** with support for custom models, DeepFace integration, and Google Cloud Storage.

This guide now uses **one unified shell script** that installs all required packages, builds Python, sets up ComfyUI, fetches cloud models, and launches the program.

---

## 🚀 Quick Setup (All-in-One)

```bash
# 1. Clone the repo
git clone https://github.com/hamdanbasriacc/NLBAging.git
cd NLBAging/LinuxOS

# 2. Make the installer executable
chmod +x setup_comfyui_full.sh

# 3. Run the full setup
./setup_comfyui_full.sh
```

---

## 📦 What This Script Does

The `setup_comfyui_full.sh` script does **everything**, in order:

1. Installs system packages (libffi-devel, bzip2-devel, xz-devel, curl, unzip)
2. Builds Python 3.10.14 locally at `~/ComfyUI/local_python/`
3. Creates and activates a venv in `~/ComfyUI/venv`
4. Installs:
   - `requirements.txt`
   - `torch` (CUDA 11.8)
   - `deepface`, `tf-keras`
5. Runs ComfyUI once to verify
6. Installs Google Cloud SDK and runs `gcloud init`
7. Clones `ComfyUI` and `NLBAging` repos
8. Downloads models from GCS into:
   - `ComfyUI/models/loras/`
   - `ComfyUI/models/checkpoints/`
9. Copies:
   - Shell scripts to `~/ComfyUI/LinuxOS`
   - Workflows to `~/ComfyUI/user/workflows`
10. Sets up `/home/admin/shared_comfy_data/` with permissions
11. Starts the ComfyUI program using `reset_and_run.sh`

✅ All steps are **idempotent** (safe to rerun)

---

## 📂 Directory Structure After Setup

```
~/ComfyUI/
├── local_python/
├── venv/
├── models/
│   ├── loras/
│   └── checkpoints/
├── LinuxOS/
│   ├── reset_and_run.sh
│   └── watch_input_and_run.sh
├── user/
│   └── workflows/
├── shared_comfy_data/
│   └── latest_aged_url.txt
```

---

## ✅ Final Step: Run the App (if not auto-launched)

```bash
cd ~/ComfyUI/LinuxOS
./reset_and_run.sh
```

---

## 🧠 About `latest_aged_url.txt`

- This file is generated by the NLB Video Stitching pipeline.
- It's automatically placed in `/home/admin/shared_comfy_data/` if not present.
- It tracks presigned upload URLs for generated images.

---

## ⏱ Timeout Handling

If your VM times out (after ~10 mins), don’t worry:

- All setup steps run **sequentially in the background**
- The log is saved to: `~/setup_full_install.log`
- When you reconnect:

```bash
tail -n 50 ~/setup_full_install.log   # Check last steps
grep error ~/setup_full_install.log   # Find any issues
```

Also check:
```bash
[ -f ~/.setup_comfyui_full_done ] && echo "✅ Setup Completed"
```

---

## 🔁 Common Commands

**Run ComfyUI manually**
```bash
cd ~/ComfyUI/LinuxOS
./reset_and_run.sh
```

**Pull repo updates**
```bash
cd ~/NLBAging
git pull
```

**Copy updated LinuxOS scripts**
```bash
cp -r ~/NLBAging/LinuxOS/* ~/ComfyUI/LinuxOS/
```

**Copy updated workflows**
```bash
cp -r ~/NLBAging/workflows ~/ComfyUI/user/
```

**Check shared_comfy_data folder**
```bash
ls -lah /home/admin/shared_comfy_data
```

**Clear old images**
```bash
rm -f /home/admin/shared_comfy_data/*.{jpg,jpeg,png}
```

---

## 🧪 Testing (2-Terminal Setup)

**Terminal 1: Run ComfyUI**
```bash
cd ~/ComfyUI/LinuxOS
./reset_and_run.sh
```

**Terminal 2: Copy test images**
```bash
cp ~/ComfyUI/user/workflows/Male_ticket-001.jpg /home/admin/shared_comfy_data/
cp ~/ComfyUI/user/workflows/Male_ticket-002.jpeg /home/admin/shared_comfy_data/
cp ~/ComfyUI/user/workflows/Male_ticket-003.jpg /home/admin/shared_comfy_data/
cp ~/ComfyUI/user/workflows/Female_ticket-001.jpg /home/admin/shared_comfy_data/
cp ~/ComfyUI/user/workflows/Female_ticket-002.jpg /home/admin/shared_comfy_data/
```

---

## ✅ You're ready to go!
